@model string

@{
    ViewData["Title"] = "Log in";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h2 class="mb-4">@ViewData["Title"]</h2>

            @* Display error messages from OAuth failures *@
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Authentication Error:</strong> @TempData["ErrorMessage"]
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            }

            <section>
                <h4>Use an external service to log in</h4>
                <hr />

                <div class="social-login-buttons">
                    @* 
                        REDIRECT-BASED OAUTH FLOW (NEW APPROACH)
                        
                        Key changes from popup-based approach:
                        1. Uses standard HTML forms with POST method
                        2. No JavaScript window.open() calls
                        3. Browser does full-page redirect (not blocked by popup blockers)
                        4. Return URL preserved via hidden input field
                        5. Works on all devices including mobile
                    *@

                    @* Google OAuth Login Button *@
                    <form asp-controller="Account" asp-action="ExternalLogin" method="post" class="d-inline">
                        <input type="hidden" name="provider" value="Google" />
                        <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />
                        <button type="submit" class="btn btn-google btn-lg btn-block mb-3" title="Log in using your Google account">
                            <i class="fab fa-google"></i> Sign in with Google
                        </button>
                    </form>

                    @* Facebook OAuth Login Button *@
                    <form asp-controller="Account" asp-action="ExternalLogin" method="post" class="d-inline">
                        <input type="hidden" name="provider" value="Facebook" />
                        <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />
                        <button type="submit" class="btn btn-facebook btn-lg btn-block mb-3" title="Log in using your Facebook account">
                            <i class="fab fa-facebook-f"></i> Sign in with Facebook
                        </button>
                    </form>

                    @* Additional providers can be added following the same pattern *@
                    @* 
                    <form asp-controller="Account" asp-action="ExternalLogin" method="post" class="d-inline">
                        <input type="hidden" name="provider" value="Microsoft" />
                        <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />
                        <button type="submit" class="btn btn-microsoft btn-lg btn-block mb-3">
                            <i class="fab fa-microsoft"></i> Sign in with Microsoft
                        </button>
                    </form>
                    *@
                </div>

                @* Information message about the authentication flow *@
                <div class="alert alert-info mt-4" role="alert">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        You will be redirected to the provider's login page. After signing in, you'll be brought back to this site.
                    </small>
                </div>
            </section>

            <hr class="my-4" />

            <section>
                <h4>Or use a local account</h4>
                <form asp-controller="Account" asp-action="Login" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    
                    <div class="form-group">
                        <label for="Email">Email</label>
                        <input type="email" name="Email" class="form-control" placeholder="name@example.com" required />
                    </div>
                    
                    <div class="form-group">
                        <label for="Password">Password</label>
                        <input type="password" name="Password" class="form-control" placeholder="Password" required />
                    </div>
                    
                    <div class="form-group form-check">
                        <input type="checkbox" name="RememberMe" class="form-check-input" id="RememberMe" />
                        <label class="form-check-label" for="RememberMe">
                            Remember me
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Log in</button>
                    
                    <div class="mt-3">
                        <a asp-action="ForgotPassword">Forgot your password?</a>
                    </div>
                    <div>
                        <a asp-action="Register" asp-route-returnurl="@ViewData["ReturnUrl"]">Register as a new user</a>
                    </div>
                </form>
            </section>
        </div>
    </div>
</div>

@section Scripts {
    @* 
        NO POPUP-RELATED JAVASCRIPT NEEDED!
        
        The old problematic approach would have looked like this:
        
        <script>
        function openOAuthPopup(provider) {
            var width = 500;
            var height = 600;
            var left = (screen.width - width) / 2;
            var top = (screen.height - height) / 2;
            
            // THIS GETS BLOCKED BY POPUP BLOCKERS!
            var popup = window.open(
                '/Account/ExternalLogin?provider=' + provider + '&returnUrl=' + encodeURIComponent('@ViewData["ReturnUrl"]'),
                'oauth',
                'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top
            );
            
            if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                alert('Please disable your popup blocker and try again.');
            }
        }
        </script>
        
        With the redirect-based approach, we don't need any of this JavaScript!
    *@
}

<style>
    /* Social login button styling */
    .btn-google {
        background-color: #dd4b39;
        color: white;
        border: none;
    }
    
    .btn-google:hover {
        background-color: #c23321;
        color: white;
    }
    
    .btn-facebook {
        background-color: #3b5998;
        color: white;
        border: none;
    }
    
    .btn-facebook:hover {
        background-color: #2d4373;
        color: white;
    }
    
    .btn-microsoft {
        background-color: #00a4ef;
        color: white;
        border: none;
    }
    
    .btn-microsoft:hover {
        background-color: #008cc9;
        color: white;
    }
    
    .social-login-buttons {
        margin-bottom: 20px;
    }
    
    .social-login-buttons .btn {
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .social-login-buttons .btn i {
        margin-right: 10px;
    }
</style>
